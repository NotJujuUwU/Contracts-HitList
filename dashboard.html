<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link rel="stylesheet" href="game.css">
  <script src="items.js"></script>
  <style>
    /* --- Tabs --- */
    .inv-tabs {
      display: flex;
      margin-bottom: 10px;
      border-bottom: 2px solid #444;
    }
    .inv-tab {
      flex: 1;
      padding: 8px;
      background: #222; /* unified dashboard background */
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 14px;
    }
    .inv-tab.active {
      background: #ffcc00;
      color: #000;
      font-weight: bold;
    }

    /* --- Scrollable Inventory Area --- */
    .inv-list-container {
      max-height: 320px;
      overflow-y: auto;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 5px;
      background: #222; /* same color as overall dashboard */
    }

    /* Custom scrollbar styling */
    .inv-list-container::-webkit-scrollbar {
      width: 10px;
    }
    .inv-list-container::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #ffcc00, #ff9900);
      border-radius: 6px;
    }
    .inv-list-container::-webkit-scrollbar-track {
      background: #222;
    }
  </style>
</head>
<body>
<div class="dashboard-layout">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="profile">
      <div class="pfp-container">
        <img id="pfp" src="images/agent.png" alt="Profile Picture">
      </div>
      <input type="file" id="pfpUpload" accept="image/*" style="display:none;" onchange="setPfp(event)">
      <h2 id="playerName"></h2>
      <p>
        <img class="money-icon" src="images/money.png" alt="Money">
        <span id="money"></span>
      </p>
    </div>
    <nav class="menu">
      <button onclick="showSection('overview')">ğŸ  Overview</button>
      <button onclick="showSection('inventory')">ğŸ’ Inventory</button>
      <button onclick="window.location.href='dungeons.html'">âš”ï¸ Dungeons</button>
      <button onclick="showSection('quests')">ğŸ“œ Quests</button>
      <button onclick="window.location.href='dealers.html'">ğŸ¬ Stores</button>
      <button onclick="window.location.href='market.html'">ğŸ¦ Marketplace</button>
      <button class="logout-btn" onclick="logout()">ğŸšª Logout</button>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="content">
    <!-- Overview -->
    <div id="overview" class="section">
      <p class="player-id">Player ID: <span id="playerID">0000000000</span></p>
      <h1>Player Overview</h1>
      <p><b>Name:</b> <span id="overviewName"></span></p>
      <p><b>Money:</b> <img class="money-icon" src="images/money.png" alt="Money"> <span id="overviewMoney"></span></p>
      <div class="stats-grid">
        <div class="stat-card"><h3>ğŸ° Dungeons Done</h3><p id="statDone">0</p></div>
        <div class="stat-card"><h3>ğŸ’€ Dungeons Failed</h3><p id="statFailed">0</p></div>
        <div class="stat-card"><h3>ğŸ“œ Quests Completed</h3><p id="statQuests">0</p></div>
        <div class="stat-card"><h3>ğŸ’° Money Earned</h3><p id="statEarned">0</p></div>
      </div>
    </div>

    <!-- Inventory -->
    <div id="inventory" class="section" style="display:none;">
      <h1>Character Inventory</h1>
      <div class="inventory-layout">
        <!-- LEFT: Stats & Level -->
        <div class="inventory-left">
          <h2>Stats</h2>
          <div class="inventory-stats">
            <ul>
              <li><img src="images/health.png" class="stat-icon" alt="Health"> Health: <span id="statHealth">100 / 100</span></li>
              <li><img src="images/mana.png" class="stat-icon" alt="Mana"> Mana: <span id="statMana">100 / 100</span></li>
              <li><img src="images/armor.png" class="stat-icon" alt="Armor"> Armor: <span id="statArmor">0</span></li>
              <li><img src="images/damage.png" class="stat-icon" alt="Damage"> Damage: <span id="statDamage">0</span></li>
              <li><img src="images/slash-resistance.png" class="stat-icon" alt="Slash"> Slash Resistance: <span id="statSlash">0</span></li>
              <li><img src="images/magic-resistance.png" class="stat-icon" alt="Magic"> Magic Resistance: <span id="statMagic">0</span></li>
              <li><img src="images/projectile-resistance.png" class="stat-icon" alt="Projectile"> Projectile Resistance: <span id="statProj">0</span></li>
            </ul>
          </div>
          <div class="stat-card">
            <h3><img src="images/star.png" class="stat-icon align-star" alt="Level"> Level</h3>
            <p id="statLevel">1</p>
            <div id="xpBarOuter"><div id="xpBarInner"></div></div>
            <small><span id="xpDisplay">0 / 100</span> XP</small>
          </div>
          <button class="btn gold" style="margin-top:10px" onclick="addXP(500)">âš¡ Give 500 XP (Test)</button>
          <button class="btn green" style="margin-top:10px" onclick="addMoney(100)">ğŸ’° Give 100 Money (Test)</button>
        </div>

        <!-- RIGHT: Tabbed Inventory -->
        <div class="inventory-right">
          <h2>Inventory</h2>

          <!-- Tabs -->
          <div class="inv-tabs">
            <button class="inv-tab active" onclick="switchInvTab('consumables')">ğŸ Consumables</button>
            <button class="inv-tab" onclick="switchInvTab('equipment')">âš”ï¸ Equipment</button>
          </div>

          <!-- Scrollable list container -->
          <div class="inv-list-container">
            <ul id="consumableList" class="inventory-list"></ul>
            <ul id="equipmentList" class="inventory-list" style="display:none;"></ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Quests -->
    <div id="quests" class="section" style="display:none;">
      <h1>Quests</h1>
      <p>Here youâ€™ll see side quests and tasks.</p>
      <button class="btn green" onclick="addXP(20)">ğŸ“œ Complete Small Quest (+20 XP)</button>
    </div>
  </main>
</div>

<!-- Popup -->
<div id="popupOverlay" class="popup-overlay" style="display:none;">
  <div class="popup-box">
    <p id="popupMessage"></p>
    <div id="popupButtons" class="popup-buttons"></div>
  </div>
</div>

<div class="version-label">v0.37</div>

<script>
  let player;

  function formatNumber(num){ return num.toLocaleString(); }

  // === POPUPS ===
  function showPopup(message,type="info"){
    const overlay=document.getElementById("popupOverlay"),
          msg=document.getElementById("popupMessage"),
          btns=document.getElementById("popupButtons");
    let icon="";
    if(type==="success") icon="<img src='images/yes.png' style='width:20px;margin-right:6px'>";
    if(type==="error")   icon="<img src='images/no.png' style='width:20px;margin-right:6px'>";
    msg.innerHTML=icon+message;
    btns.innerHTML="";
    const ok=document.createElement("button");
    ok.className="btn gold"; ok.innerText="OK"; ok.onclick=()=>closePopup();
    btns.appendChild(ok);
    overlay.style.display="flex";
    overlay.className="popup-overlay "+type;
  }
  function closePopup(){ document.getElementById("popupOverlay").style.display="none"; }

  // === ITEM ICON HELPER ===
  function getItemIcon(itemName){
    const fileName=itemName.toLowerCase().replace(/\s+/g,"-")+".png";
    return "images/"+fileName;
  }

  // === XP + LEVELS ===
  function addXP(amount){
    player.xp += amount;
    while(player.xp >= player.nextLevelXp){
      player.xp -= player.nextLevelXp;
      player.level++;
      player.nextLevelXp = Math.floor(player.nextLevelXp*1.25);
      showPopup(`Level Up! You are now Level ${player.level}`,"success");
    }
    savePlayer(); updateXPUI();
  }
  function updateXPUI(){
    document.getElementById("statLevel").innerText=player.level;
    const percent=Math.floor((player.xp/player.nextLevelXp)*100);
    document.getElementById("xpDisplay").innerText=`${player.xp} / ${player.nextLevelXp} XP (${percent}%)`;
    const bar=document.getElementById("xpBarInner");
    bar.style.width=percent+"%";
    if(percent>=100){ bar.classList.add("full"); } 
    else { bar.classList.remove("full"); }
  }

  // === HEAL & MANA RESTORE ===
  function heal(amount){
    if(player.stats.health >= player.stats.maxHealth){
      showPopup("You are already at full Health!", "info");
      return false;
    }
    player.stats.health = Math.min(player.stats.health + amount, player.stats.maxHealth);
    savePlayer(); updateStatsUI();
    showPopup(`You recovered ${amount} HP!`, "success");
    return true;
  }
  function restoreMana(amount){
    if(player.stats.mana >= player.stats.maxMana){
      showPopup("You are already at full Mana!", "info");
      return false;
    }
    player.stats.mana = Math.min(player.stats.mana + amount, player.stats.maxMana);
    savePlayer(); updateStatsUI();
    showPopup(`You recovered ${amount} Mana!`, "success");
    return true;
  }

  // === UPDATE STATS ===
  function updateStatsUI(){
    document.getElementById("statHealth").innerText = `${player.stats.health} / ${player.stats.maxHealth}`;
    document.getElementById("statMana").innerText   = `${player.stats.mana} / ${player.stats.maxMana}`;
    document.getElementById("statArmor").innerText  = player.stats.armor;
    document.getElementById("statDamage").innerText = player.stats.damage;
    document.getElementById("statSlash").innerText  = player.stats.slashRes;
    document.getElementById("statMagic").innerText  = player.stats.magicRes;
    document.getElementById("statProj").innerText   = player.stats.projRes;
  }

  // === EQUIPMENT ===
  function equipItem(itemName){
    const item=player.inventory.find(i=>i.item===itemName);
    const def=ITEMS.find(it=>it.name===itemName);
    if(!item||!def) return;
    player.inventory.forEach(it=>{
      const d=ITEMS.find(dd=>dd.name===it.item);
      if(d&&d.slot===def.slot){ it.equipped=false; }
    });
    item.equipped=true;
    savePlayer(); renderInventory(); updateStatsFromEquipment();
  }
  function unequipItem(itemName){
    const item=player.inventory.find(i=>i.item===itemName);
    if(!item) return;
    item.equipped=false;
    savePlayer(); renderInventory(); updateStatsFromEquipment();
  }
  function updateStatsFromEquipment(){
    const currentHP = player.stats.health;
    const currentMana = player.stats.mana;
    player.stats={health:currentHP, maxHealth:100, mana:currentMana, maxMana:100, armor:0, slashRes:0, magicRes:0, projRes:0, damage:0};
    player.inventory.forEach(it=>{
      if(it.equipped){
        const def=ITEMS.find(d=>d.name===it.item);
        if(def&&def.stats){ 
          for(let s in def.stats){ 
            if(s === "maxHealth"){ player.stats.maxHealth += def.stats[s]; }
            else if(s === "maxMana"){ player.stats.maxMana += def.stats[s]; }
            else { player.stats[s] += def.stats[s]; }
          }
        }
      }
    });
    player.stats.health = Math.min(player.stats.health, player.stats.maxHealth);
    player.stats.mana   = Math.min(player.stats.mana, player.stats.maxMana);
    savePlayer(); updateStatsUI();
  }

  // === INVENTORY SPLIT & RENDER ===
  function renderInventory(){
    const consumableList=document.getElementById("consumableList");
    const equipmentList=document.getElementById("equipmentList");
    consumableList.innerHTML="";
    equipmentList.innerHTML="";

    player.inventory.filter(i=>i.qty>0).forEach(i=>{
      let iconPath=getItemIcon(i.item);
      const def=ITEMS.find(it=>it.name===i.item);
      const equippedClass=i.equipped?"equipped":"";
      const statsPreview = def?.stats
        ? Object.entries(def.stats).map(([k,v]) => `${k}: +${v}`).join(", ")
        : "";

      let actionButton = "";
      if(def?.type === "consumable"){
        actionButton = `<button class="btn gold" onclick="useItem('${i.item}')">Use</button>`;
      } else if(i.equipped){
        actionButton = `<button class="btn red" onclick="unequipItem('${i.item}')">Unequip</button>`;
      } else if(def?.slot){ 
        actionButton = `<button class="btn green" onclick="equipItem('${i.item}')">Equip</button>`;
      }

      const row=`
        <li class="inventory-row ${equippedClass}" title="${statsPreview}">
          <span class="inv-qty">${i.qty}</span>
          <img class="item-icon" src="${iconPath}" alt="${i.item}" onerror="this.src='images/item.png';">
          <span class="inv-name">${i.item}</span>
          ${actionButton}
        </li>`;

      if(def?.type==="consumable"){ consumableList.innerHTML+=row; }
      else { equipmentList.innerHTML+=row; }
    });
  }

  // === USE ITEM ===
  function useItem(itemName){
    const invItem = player.inventory.find(i => i.item === itemName);
    const def = ITEMS.find(it => it.name === itemName);
    if(!invItem || !def || !def.use) return;
    const wasUsed = def.use();  // must return true/false
    if(wasUsed){
      invItem.qty--;
      if(invItem.qty <= 0){
        player.inventory = player.inventory.filter(i=>i.item !== itemName);
      }
      savePlayer();
      renderInventory();
    }
  }

  // === MONEY ===
  function addMoney(amount){
    player.money += amount;
    savePlayer();
    document.getElementById("money").innerText = formatNumber(player.money);
    document.getElementById("overviewMoney").innerText = formatNumber(player.money);
  }

  // === SWITCH INV TAB ===
  function switchInvTab(tab) {
    const consumableList = document.getElementById("consumableList");
    const equipmentList = document.getElementById("equipmentList");
    const tabs = document.querySelectorAll(".inv-tab");

    if(tab === "consumables") {
      consumableList.style.display = "block";
      equipmentList.style.display = "none";
    } else {
      consumableList.style.display = "none";
      equipmentList.style.display = "block";
    }

    tabs.forEach(btn => btn.classList.remove("active"));
    if(tab === "consumables") { tabs[0].classList.add("active"); }
    else { tabs[1].classList.add("active"); }
  }

  // === LOAD/SAVE ===
  function loadPlayer(){
    const username=localStorage.getItem("lifeSim_currentUser");
    if(!username){ window.location.href="index.html"; return;}
    player=JSON.parse(localStorage.getItem("lifeSim_"+username))||{};
    if(!player.inventory) player.inventory=[];
    if(!player.money) player.money=0;
    if(!player.pfp) player.pfp="images/agent.png";
    if(!player.dungeonsDone) player.dungeonsDone=0;
    if(!player.dungeonsFailed) player.dungeonsFailed=0;
    if(!player.totalEarned) player.totalEarned=0;
    if(!player.questsCompleted) player.questsCompleted=0;
    if(!player.playerID) player.playerID=Array.from({length:10},()=>Math.floor(Math.random()*10)).join("");
    if(!player.level) player.level=1;
    if(!player.xp) player.xp=0;
    if(!player.nextLevelXp) player.nextLevelXp=100;
    if(!player.stats){ 
      player.stats={health:100,maxHealth:100,mana:100,maxMana:100,armor:0,slashRes:0,magicRes:0,projRes:0,damage:0};
    }
    savePlayer();
    document.getElementById("playerName").innerText=player.username;
    document.getElementById("money").innerText=formatNumber(player.money);
    document.getElementById("overviewName").innerText=player.username;
    document.getElementById("overviewMoney").innerText=formatNumber(player.money);
    document.getElementById("pfp").src=player.pfp;
    document.getElementById("playerID").innerText=player.playerID;
    document.getElementById("statDone").innerText=formatNumber(player.dungeonsDone);
    document.getElementById("statFailed").innerText=formatNumber(player.dungeonsFailed);
    document.getElementById("statEarned").innerText=formatNumber(player.totalEarned);
    document.getElementById("statQuests").innerText=formatNumber(player.questsCompleted);
    renderInventory(); updateStatsUI(); updateXPUI();
  }

  function savePlayer(){ if(player&&player.username) localStorage.setItem("lifeSim_"+player.username,JSON.stringify(player)); }
  function showSection(id){ document.querySelectorAll(".section").forEach(sec=>sec.style.display="none"); document.getElementById(id).style.display="block"; }
  function logout(){ localStorage.removeItem("lifeSim_currentUser"); window.location.href="index.html"; }

  loadPlayer();
</script>
</body>
</html>